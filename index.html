
          const handleCompleteBooking = async () => {
              const hasCanopySelection = Object.values(selectedCanopies).some(q => q > 0);
              if (!hasCanopySelection) {
                  alert("Please make a selection before completing the booking.");
                  return;
              }

              // --- 1. Save to Supabase and Get ID ---
              const { subtotal, sst, deliveryFee, grandTotal, deposit } = financials;
              
              const bookingPayload = {
                  full_name: bookingDetails.fullName,
                  email: bookingDetails.email,
                  phone: bookingDetails.phone,
                  event_date: bookingDetails.eventDate,
                  event_time: bookingDetails.eventTime,
                  location: bookingDetails.location,
                  guest_count: bookingDetails.guestCount,
                  special_requests: bookingDetails.specialRequests,
                  booking_mode: bookingMode,
                  selected_items: {
                      canopies: selectedCanopies,
                      package: selectedPackage,
                      accessories: selectedAccessories,
                      color: selectedColor
                  },
                  total_price: grandTotal,
                  deposit_amount: deposit,
                  status: 'Pending'
              };

              let bookingId = 'BARU';

              try {
                  const { data, error } = await supabaseClient
                    .from('bookings')
                    .insert(bookingPayload)
                    .select()
                    .single();
                  
                  if (error) {
                      console.error("Supabase Insert Error:", error);
                      // Don't stop flow, just log error, user can still whatsapp
                  } else if (data) {
                      bookingId = `#${data.id}`;
                  }
              } catch (err) {
                  console.error("Booking Error:", err);
              }

              // --- 2. Construct WhatsApp Message ---
              // Gunakan format standard
              let msg = `Salam BMC Canopy, saya ingin membuat tempahan (${bookingId}).\n\n`;
              
              msg += `*MAKLUMAT PELANGGAN*\n`;
              msg += `Nama: ${bookingDetails.fullName || '-'}\n`;
              msg += `No. Tel: ${bookingDetails.phone || '-'}\n`;
              msg += `Tarikh: ${bookingDetails.eventDate || '-'}\n`;
              msg += `Masa: ${bookingDetails.eventTime || '-'}\n`;
              msg += `Lokasi: ${bookingDetails.location || '-'}\n`;
              msg += `Tetamu: ${bookingDetails.guestCount || '-'}\n\n`;
              
              msg += `*SENARAI TEMPAHAN*\n`;
              
              if (bookingMode === BookingMode.AlaCarte) {
                Object.entries(selectedCanopies).forEach(([compositeId, quantity]) => {
                    if (quantity > 0) {
                        const idParts = compositeId.split('_');
                        const canopyId = idParts[0];
                        const sizeName = idParts.length > 1 ? idParts[1] : null;
                        const canopy = canopiesData.find(c => c.id == canopyId);
                        if (canopy) {
                            let name = canopy.name;
                            if (sizeName) name = `${canopy.name} (${sizeName})`;
                            msg += `- ${name} (x${quantity})\n`;
                        }
                    }
                });
              }

              if (bookingMode === BookingMode.Package && selectedPackage) {
                  msg += `- Pakej: ${selectedPackage.name}\n`;
              }

              if (selectedColor) {
                  msg += `- Warna Kanopi: ${selectedColor.name}\n`;
              }
              
              const accessoryEntries = Object.entries(selectedAccessories).filter(([, qty]) => qty > 0);
              if (accessoryEntries.length > 0) {
                  msg += `\n*Tambahan (Accessories):*\n`;
                  accessoryEntries.forEach(([id, quantity]) => {
                      const accessory = accessoriesData.find(a => a.id == id);
                      if (accessory) {
                          msg += `- ${accessory.name} (x${quantity})\n`;
                      }
                  });
              }

              if (bookingDetails.specialRequests) {
                  msg += `\n*Catatan*: ${bookingDetails.specialRequests}\n`;
              }

              msg += `\n*RINGKASAN BAYARAN*\n`;
              msg += `Jumlah Besar: RM ${grandTotal.toFixed(2)}\n`;
              msg += `Deposit (50%): RM ${deposit.toFixed(2)}\n`;
              msg += `\nMohon pengesahan ketersediaan. Terima kasih.`;

              // Encode message correctly for URL
              const encodedMessage = encodeURIComponent(msg);
              
              // Use official WhatsApp API link instead of wasap.my for better reliability with long text
              const whatsappUrl = `https://wa.me/60166327901?text=${encodedMessage}`;

              // --- 3. Redirect ---
              window.open(whatsappUrl, '_blank');
              
              alert('Tempahan disimpan! Anda akan dibawa ke WhatsApp untuk menghantar butiran tempahan.');

              navigateToHome();
          };
